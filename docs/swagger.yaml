openapi: 3.0.3
info:
  title: OrdFS Server API
  description: |
    API server for serving Bitcoin ordinal inscriptions and OrdFS content.

    Supports:
    - Content retrieval by txid or outpoint
    - Version tracking for ordinal reinscriptions
    - OrdFS directory navigation
    - DNS-based custom domain routing
    - Block and transaction queries
  version: 1.0.0
  contact:
    name: OrdFS Server
servers:
  - url: /
    description: Current server

paths:
  /health:
    get:
      summary: Health check
      description: Returns the server health status
      operationId: healthCheck
      tags:
        - Health
      responses:
        '200':
          description: Server is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok

  /v1/bsv/block/latest:
    get:
      summary: Get latest block
      description: Returns the latest block header from the longest chain
      operationId: getLatestBlock
      tags:
        - Block
      responses:
        '200':
          description: Latest block header (flattened structure)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BlockHeader'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v1/bsv/block/height/{height}:
    get:
      summary: Get block by height
      description: Returns block header for a specific height
      operationId: getBlockByHeight
      tags:
        - Block
      parameters:
        - name: height
          in: path
          required: true
          description: Block height
          schema:
            type: integer
      responses:
        '200':
          description: Block header
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BlockHeader'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v1/bsv/block/hash/{hash}:
    get:
      summary: Get block by hash
      description: Returns block state for a specific hash
      operationId: getBlockByHash
      tags:
        - Block
      parameters:
        - name: hash
          in: path
          required: true
          description: Block hash (64 hex characters)
          schema:
            type: string
            pattern: '^[0-9a-fA-F]{64}$'
      responses:
        '200':
          description: Block state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BlockState'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v1/bsv/tx/{txid}:
    get:
      summary: Get raw transaction
      description: Returns raw transaction bytes
      operationId: getRawTransaction
      tags:
        - Transaction
      parameters:
        - name: txid
          in: path
          required: true
          description: Transaction ID (64 hex characters)
          schema:
            type: string
            pattern: '^[0-9a-fA-F]{64}$'
      responses:
        '200':
          description: Raw transaction bytes
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v2/tx/{txid}:
    get:
      summary: Get raw transaction (v2)
      description: Returns raw transaction bytes in binary format
      operationId: getRawTransactionV2
      tags:
        - Transaction
      parameters:
        - name: txid
          in: path
          required: true
          description: Transaction ID (64 hex characters)
          schema:
            type: string
            pattern: '^[0-9a-fA-F]{64}$'
      responses:
        '200':
          description: Raw transaction bytes
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v2/tx/{txid}/proof:
    get:
      summary: Get merkle proof for transaction
      description: Returns merkle proof for transaction verification
      operationId: getMerkleProof
      tags:
        - Transaction
      parameters:
        - name: txid
          in: path
          required: true
          description: Transaction ID (64 hex characters)
          schema:
            type: string
            pattern: '^[0-9a-fA-F]{64}$'
      responses:
        '200':
          description: Merkle proof data
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        '400':
          $ref: '#/components/responses/BadRequest'
        '501':
          description: Not implemented yet
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v2/tx/{txid}/beef:
    get:
      summary: Get BEEF data for transaction
      description: Returns Background Evaluation Extended Format (BEEF) data with all transaction dependencies
      operationId: getBeef
      tags:
        - Transaction
      parameters:
        - name: txid
          in: path
          required: true
          description: Transaction ID (64 hex characters)
          schema:
            type: string
            pattern: '^[0-9a-fA-F]{64}$'
      responses:
        '200':
          description: BEEF formatted transaction data
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        '400':
          $ref: '#/components/responses/BadRequest'
        '501':
          description: Not implemented yet
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v2/tx/{txid}/{outputIndex}:
    get:
      summary: Get specific transaction output
      description: Returns raw binary data for a specific transaction output
      operationId: getOutput
      tags:
        - Transaction
      parameters:
        - name: txid
          in: path
          required: true
          description: Transaction ID (64 hex characters)
          schema:
            type: string
            pattern: '^[0-9a-fA-F]{64}$'
        - name: outputIndex
          in: path
          required: true
          description: Output index (vout)
          schema:
            type: integer
            minimum: 0
      responses:
        '200':
          description: Raw output data
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        '400':
          $ref: '#/components/responses/BadRequest'
        '501':
          description: Not implemented yet
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /preview/{b64HtmlData}:
    get:
      summary: Render HTML preview
      description: Renders base64-encoded HTML data as a preview
      operationId: renderPreview
      tags:
        - Preview
      parameters:
        - name: b64HtmlData
          in: path
          required: true
          description: Base64-encoded HTML data
          schema:
            type: string
      responses:
        '200':
          description: Rendered HTML page
          content:
            text/html:
              schema:
                type: string
        '400':
          $ref: '#/components/responses/BadRequest'

  /preview:
    post:
      summary: Render HTML preview (POST)
      description: Renders HTML data from request body as a preview
      operationId: renderPreviewPost
      tags:
        - Preview
      requestBody:
        required: true
        content:
          text/html:
            schema:
              type: string
      responses:
        '200':
          description: Rendered HTML page
          content:
            text/html:
              schema:
                type: string
        '400':
          $ref: '#/components/responses/BadRequest'

  /content/{locator}:
    get:
      summary: Get inscription content
      description: |
        Returns inscription or B protocol content.

        Supports MAP protocol metadata extraction and ordinal sequence tracking.
      operationId: getContent
      tags:
        - Content
      parameters:
        - name: locator
          in: path
          required: true
          description: |
            Content locator in one of these formats:
            - `txid` - 64 hex characters, returns first inscription in transaction
            - `txid_vout` - Outpoint format, returns content at specific output
            - `txid_vout:seq` - Outpoint with sequence number (relative to the specified outpoint)
              - `:0` = content at this specific outpoint
              - `:N` = content N spends forward from this outpoint
              - `:-1` = latest version (follows spend chain to current unspent location)
          schema:
            type: string
        - name: map
          in: query
          required: false
          description: |
            Include merged MAP protocol metadata in X-Map header.
            MAP data is merged across all spends up to the requested version
            using last-write-wins semantics.
          schema:
            type: boolean
        - name: content
          in: query
          required: false
          description: Whether to return content body
          schema:
            type: boolean
        - name: out
          in: query
          required: false
          description: Include base64-encoded output script in X-Output header
          schema:
            type: boolean
      responses:
        '200':
          description: Content with appropriate content type
          headers:
            Content-Type:
              schema:
                type: string
              description: MIME type of the content
            X-Outpoint:
              schema:
                type: string
              description: Current outpoint of the ordinal satoshi (txid_vout format)
            X-Origin:
              schema:
                type: string
              description: Origin outpoint where the ordinal satoshi was created
            X-Ord-Seq:
              schema:
                type: string
              description: Sequence number indicating how many inscription revisions exist at this outpoint
            X-Map:
              schema:
                type: string
              description: |
                JSON-encoded MAP protocol metadata (only present if map=true).
                Contains merged key-value pairs from all MAP SET commands
                encountered in the spend chain.
            X-Output:
              schema:
                type: string
              description: Base64-encoded output script (only present if out=true)
            Cache-Control:
              schema:
                type: string
              description: |
                Caching directive:
                - seq=-1: "no-cache, no-store, must-revalidate" (latest sequence, no cache)
                - seq>=0: "public, max-age=86400, immutable" (specific sequence, long cache)
          content:
            '*/*':
              schema:
                type: string
                format: binary
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'
    head:
      summary: Get content metadata without body
      description: |
        Returns the same headers as GET but without the response body.
        This is the preferred method for querying metadata (content type, outpoint, origin, sequence)
        without downloading the actual content.
      operationId: headContent
      tags:
        - Content
      parameters:
        - name: locator
          in: path
          required: true
          description: |
            Content locator in one of these formats:
            - `txid` - 64 hex characters, returns first inscription in transaction
            - `txid_vout` - Outpoint format, returns content at specific output
            - `txid_vout:seq` - Outpoint with sequence number (relative to the specified outpoint)
              - `:0` = content at this specific outpoint
              - `:N` = content N spends forward from this outpoint
              - `:-1` = latest version (follows spend chain to current unspent location)
          schema:
            type: string
        - name: map
          in: query
          required: false
          description: |
            Include merged MAP protocol metadata in X-Map header.
            MAP data is merged across all spends up to the requested version
            using last-write-wins semantics.
          schema:
            type: boolean
        - name: out
          in: query
          required: false
          description: Include base64-encoded output script in X-Output header
          schema:
            type: boolean
      responses:
        '200':
          description: Metadata headers with no body
          headers:
            Content-Type:
              schema:
                type: string
              description: MIME type of the content
            Content-Length:
              schema:
                type: integer
              description: Size of the content in bytes
            X-Outpoint:
              schema:
                type: string
              description: Current outpoint of the ordinal satoshi (txid_vout format)
            X-Origin:
              schema:
                type: string
              description: Origin outpoint where the ordinal satoshi was created
            X-Ord-Seq:
              schema:
                type: string
              description: Sequence number indicating how many inscription revisions exist at this outpoint
            X-Map:
              schema:
                type: string
              description: |
                JSON-encoded MAP protocol metadata (only present if map=true).
                Contains merged key-value pairs from all MAP SET commands
                encountered in the spend chain.
            X-Output:
              schema:
                type: string
              description: Base64-encoded output script (only present if out=true)
            Cache-Control:
              schema:
                type: string
              description: |
                Caching directive:
                - seq=-1: "no-cache, no-store, must-revalidate" (latest sequence, no cache)
                - seq>=0: "public, max-age=86400, immutable" (specific sequence, long cache)
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /content/{locator}/{filename}:
    get:
      summary: Get file from OrdFS directory
      description: |
        Loads an OrdFS directory and returns a specific file.
        Directory must be a JSON inscription mapping filenames to ord:// locators.

        Supports SPA fallback - if file not found, returns index.html.
        If no filename provided and directory detected, redirects to index.html (unless raw=true).
      operationId: getDirectoryFile
      tags:
        - Content
      parameters:
        - name: locator
          in: path
          required: true
          description: |
            Directory locator in one of these formats:
            - `txid` - 64 hex characters
            - `txid_vout` - Outpoint format
            - `txid_vout:seq` - Outpoint with sequence number (relative to the specified outpoint)
              - `:0` = content at this specific outpoint
              - `:N` = content N spends forward from this outpoint
              - `:-1` = latest version (follows spend chain to current unspent location)
          schema:
            type: string
        - name: filename
          in: path
          required: true
          description: Filename to retrieve from directory (if not found, falls back to index.html)
          schema:
            type: string
            example: "style.css"
        - name: raw
          in: query
          required: false
          description: If set, prevents redirect to index.html for directory content
          schema:
            type: string
        - name: map
          in: query
          required: false
          description: Include MAP protocol metadata in X-Map header
          schema:
            type: boolean
        - name: content
          in: query
          required: false
          description: Whether to return content body
          schema:
            type: boolean
        - name: out
          in: query
          required: false
          description: Include base64-encoded output script in X-Output header
          schema:
            type: boolean
      responses:
        '200':
          description: File content with appropriate content type
          headers:
            Content-Type:
              schema:
                type: string
              description: MIME type of the file
            X-Outpoint:
              schema:
                type: string
              description: Resolved outpoint for the file
            X-Origin:
              schema:
                type: string
              description: Origin outpoint where the ordinal satoshi was created
            X-Ord-Seq:
              schema:
                type: string
              description: Ordinal sequence number of this file
            X-Map:
              schema:
                type: string
              description: JSON-encoded MAP protocol metadata (if map=true)
            X-Output:
              schema:
                type: string
              description: Base64-encoded output script (if out=true)
            Cache-Control:
              schema:
                type: string
              description: Caching directive
          content:
            '*/*':
              schema:
                type: string
                format: binary
        '302':
          description: Redirect to index.html for directory without filename
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /:
    get:
      summary: Root endpoint with DNS routing
      description: |
        Returns content based on DNS TXT record for custom domains.
        If canonical host or no DNS configuration, returns frontend index page.

        DNS TXT record format: _ordfs.yourdomain.com â†’ ordfs=<outpoint>[:seq]

        If content is ord-fs/json directory, redirects to /index.html (unless raw=true).
      operationId: getRoot
      tags:
        - DNS
      parameters:
        - name: raw
          in: query
          required: false
          description: If set, prevents redirect to index.html for directory content
          schema:
            type: string
        - name: map
          in: query
          required: false
          description: Include MAP protocol metadata in X-Map header
          schema:
            type: boolean
        - name: content
          in: query
          required: false
          description: Whether to return content body
          schema:
            type: boolean
        - name: out
          in: query
          required: false
          description: Include base64-encoded output script in X-Output header
          schema:
            type: boolean
      responses:
        '200':
          description: Content or frontend page
          headers:
            Content-Type:
              schema:
                type: string
              description: MIME type of the content
            X-Outpoint:
              schema:
                type: string
              description: Resolved outpoint (for inscription content)
            X-Origin:
              schema:
                type: string
              description: Origin outpoint where the ordinal satoshi was created
            X-Ord-Seq:
              schema:
                type: string
              description: Ordinal sequence number (for inscription content)
            X-Map:
              schema:
                type: string
              description: JSON-encoded MAP protocol metadata (if map=true)
            X-Output:
              schema:
                type: string
              description: Base64-encoded output script (if out=true)
            Cache-Control:
              schema:
                type: string
              description: Caching directive (for inscription content)
          content:
            '*/*':
              schema:
                type: string
        '302':
          description: Redirect to /index.html for directory content
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /{locator}:
    get:
      summary: Smart route for inscription or DNS file
      description: |
        Multi-purpose catch-all endpoint with priority order:
        1. Try to parse as valid inscription locator (txid, outpoint, or with :seq suffix)
        2. If valid locator found, load content directly
        3. If not valid locator and DNS enabled, lookup domain's DNS TXT record
        4. Load file from DNS-configured directory

        Supports ord-fs/json redirect to index.html (unless raw=true).
      operationId: getFileOrLocator
      tags:
        - DNS
      parameters:
        - name: locator
          in: path
          required: true
          description: |
            Content locator or filename:
            - `txid` - 64 hex characters
            - `txid_vout` - Outpoint format
            - `txid_vout:seq` - Outpoint with sequence number (relative to the specified outpoint)
              - `:0` = content at this specific outpoint
              - `:N` = content N spends forward from this outpoint
              - `:-1` = latest version (follows spend chain to current unspent location)
            - `filename.ext` - File name (DNS routing only)
          schema:
            type: string
        - name: raw
          in: query
          required: false
          description: If set, prevents redirect for ord-fs/json content
          schema:
            type: string
        - name: map
          in: query
          required: false
          description: Include MAP protocol metadata in X-Map header
          schema:
            type: boolean
        - name: content
          in: query
          required: false
          description: Whether to return content body
          schema:
            type: boolean
        - name: out
          in: query
          required: false
          description: Include base64-encoded output script in X-Output header
          schema:
            type: boolean
      responses:
        '200':
          description: Content with appropriate content type
          headers:
            Content-Type:
              schema:
                type: string
              description: MIME type of the content
            X-Outpoint:
              schema:
                type: string
              description: Resolved outpoint for the content
            X-Origin:
              schema:
                type: string
              description: Origin outpoint where the ordinal satoshi was created
            X-Ord-Seq:
              schema:
                type: string
              description: Ordinal sequence number
            X-Map:
              schema:
                type: string
              description: JSON-encoded MAP protocol metadata (if map=true)
            X-Output:
              schema:
                type: string
              description: Base64-encoded output script (if out=true)
            Cache-Control:
              schema:
                type: string
              description: Caching directive
          content:
            '*/*':
              schema:
                type: string
                format: binary
        '302':
          description: Redirect to index.html for ord-fs/json
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /{locator}/{filename}:
    get:
      summary: Get file from directory (catch-all)
      description: |
        Catch-all route that handles directory file access with flexible locator formats.
        Supports both direct locator access and DNS-based routing.

        Locator can include :seq suffix for versioning.
        Implements SPA fallback to index.html if file not found.
      operationId: getFile
      tags:
        - DNS
      parameters:
        - name: locator
          in: path
          required: true
          description: |
            Directory locator or path segment:
            - `txid` - 64 hex characters
            - `txid_vout` - Outpoint format
            - `txid_vout:seq` - Outpoint with sequence number (relative to the specified outpoint)
              - `:0` = content at this specific outpoint
              - `:N` = content N spends forward from this outpoint
              - `:-1` = latest version (follows spend chain to current unspent location)
            - Path segment (DNS routing only)
          schema:
            type: string
        - name: filename
          in: path
          required: true
          description: Filename to retrieve (falls back to index.html if not found)
          schema:
            type: string
        - name: raw
          in: query
          required: false
          description: Prevents redirect for directory content
          schema:
            type: string
        - name: map
          in: query
          required: false
          description: Include MAP protocol metadata in X-Map header
          schema:
            type: boolean
        - name: content
          in: query
          required: false
          description: Whether to return content body
          schema:
            type: boolean
        - name: out
          in: query
          required: false
          description: Include base64-encoded output script in X-Output header
          schema:
            type: boolean
      responses:
        '200':
          description: File content
          headers:
            Content-Type:
              schema:
                type: string
            X-Outpoint:
              schema:
                type: string
            X-Origin:
              schema:
                type: string
            X-Ord-Seq:
              schema:
                type: string
            X-Map:
              schema:
                type: string
            X-Output:
              schema:
                type: string
            Cache-Control:
              schema:
                type: string
          content:
            '*/*':
              schema:
                type: string
                format: binary
        '302':
          description: Redirect to index.html
        '404':
          $ref: '#/components/responses/NotFound'

components:
  schemas:
    BlockHeader:
      type: object
      description: Bitcoin block header information
      properties:
        height:
          type: integer
          description: Block height in the chain
          example: 800000
        hash:
          type: string
          description: Block hash (64 hex characters)
          example: 000000000000000000d5c78530c2e25e8b8b8e2e2a8f8e8e2e2a8f8e8e2e2a8f
        version:
          type: integer
          description: Block version number
          example: 536870912
        merkleRoot:
          type: string
          description: Merkle root hash of all transactions
          example: 4a5e1e4baab89f3a32518a88c31bc87f618f76673e2cc77ab2127b7afdeda33b
        creationTimestamp:
          type: integer
          description: Block creation timestamp (Unix epoch)
          example: 1234567890
        difficultyTarget:
          type: integer
          description: Difficulty target (bits field)
          example: 486604799
        nonce:
          type: integer
          description: Nonce used in proof-of-work
          example: 1234567890
        prevBlockHash:
          type: string
          description: Hash of the previous block
          example: 000000000000000000a5c78530c2e25e8b8b8e2e2a8f8e8e2e2a8f8e8e2e2a8f

    BlockState:
      type: object
      description: Block state information including header and chain status (flattened structure)
      properties:
        height:
          type: integer
          description: Block height in the chain
          example: 800000
        hash:
          type: string
          description: Block hash (64 hex characters)
          example: 000000000000000000d5c78530c2e25e8b8b8e2e2a8f8e8e2e2a8f8e8e2e2a8f
        version:
          type: integer
          description: Block version number
          example: 536870912
        prevBlockHash:
          type: string
          description: Hash of the previous block
          example: 000000000000000000a5c78530c2e25e8b8b8e2e2a8f8e8e2e2a8f8e8e2e2a8f
        merkleRoot:
          type: string
          description: Merkle root hash of all transactions
          example: 4a5e1e4baab89f3a32518a88c31bc87f618f76673e2cc77ab2127b7afdeda33b
        creationTimestamp:
          type: integer
          description: Block creation timestamp (Unix epoch)
          example: 1234567890
        difficultyTarget:
          type: integer
          description: Difficulty target (bits field)
          example: 486604799
        nonce:
          type: integer
          description: Nonce used in proof-of-work
          example: 1234567890
        state:
          type: string
          description: Block chain state
          enum:
            - LONGEST_CHAIN
            - STALE
            - ORPHAN
            - REJECTED
          example: LONGEST_CHAIN

    Error:
      type: object
      properties:
        error:
          type: string
          example: Error message

  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

tags:
  - name: Health
    description: Health check endpoints
  - name: Block
    description: Block information queries
  - name: Transaction
    description: Transaction data retrieval
  - name: Preview
    description: HTML preview rendering
  - name: Content
    description: Inscription and content retrieval
  - name: DNS
    description: DNS-based routing and custom domains
