<!DOCTYPE html>
<html lang="en">
  <head>
    {{template "head" .}}

    <script>
      function getComplementaryDarkColor(lightColor) {
        const rgb = lightColor
          .match(/[A-Za-z0-9]{2}/g)
          .map((component) => parseInt(component, 16));
        const darkColor = rgb.map((component) => Math.max(0, component - 50));
        const darkHexColor = `#${darkColor
          .map((component) => component.toString(16).padStart(2, "0"))
          .join("")}`;
        return darkHexColor;
      }

      const preview = (html) => {
        if (html && html.length > 0) {
          try {
            const b64 = btoa(html);
            document.querySelector("#preview").src = "/preview/" + b64;
          } catch (e) {
            console.error("Invalid base64 encoded html");
          }
        }
      };
      const fetchBlockStats = async () => {
        try {
          const response = await fetch("/block/latest");
          const { height, hash } = await response.json();
          console.log({ height, hash });
          if (height && hash) {
            const color = stringToColor(hash);
            const color2 = stringToColor(height);
            const blinkingCursor = document.createElement("span");
            blinkingCursor.classList.add("animate-pulse");
            blinkingCursor.innerHTML = "|";

            document.querySelector(
              "#latest-block"
            ).innerHTML = `<span class="text-[${color2}]">block-${height} $</span> <span class="text-emerald-200">Your ordfs-server is up and running.</span><br />
<span class="text-[${color2}]">block-${height} $</span> <span class="bg-clip-text text-transparent bg-gradient-to-r to-[${color}] from-[${color2}]">Terminal colors derived from blockchain data</span><br />
<span class="text-[${color2}]">block-${height} $</span> Latest block hash <span class="bg-clip-text text-transparent bg-gradient-to-r to-[${color}] from-[${color2}]">${hash.slice(
              -10
            )}</span><br />

<span class="text-[${color2}]">block-${height} $</span><br />
<span class="text-[${color2}]">block-${height} $</span> Set a <span class="text-[${color2}]">TXT</span> record on your domain <br />
<span class="text-[${color2}]">block-${height} $</span> to point to an ordinal. <br />
<span class="text-[${color2}]">block-${height} $</span> TXT='ordfs=<span class="text-[${color2}]">inscriptionId</span>'<br />
<span class="text-[${color2}]">block-${height} $</span> hostname='<span class="text-[${color2}]">_ordfs.myhostname.com</span>'<br />
<span class="text-[${color2}]">block-${height} $</span> Where <span class="text-[${color2}]">inscriptionId</span> is <span class="text-[${color2}]">txid</span>_<span class="text-[${color2}]">vout</span> on BSV,<br /><span class="text-[${color2}]">block-${height} $</span> and {<span class="text-[${color2}]">txid</span>}i{<span class="text-[${color2}]">vin</span>} on BTC.<br />
<span class="text-[${color2}]">block-${height} $</span><br />
<span class="text-[${color2}]">block-${height} $</span> Set a <span class="text-[${color2}]">A</span> or <span class="text-[${color2}]">CNAME</span> record on your domain <br />
<span class="text-[${color2}]">block-${height} $</span> to point to your ordfs-server.<br />
<span class="text-[${color2}]">block-${height} $</span> A=<span class="text-[${color2}]">10.10.10.10</span> / CNAME=<span class="text-[${color2}]">subdomain.mydomain.com</span><br /><span class="text-[${color2}]">block-${height} $</span> `;

            const darkColor = getComplementaryDarkColor(color);
            const darkColor2 = getComplementaryDarkColor(color2);

            document.querySelector("#latest-block").appendChild(blinkingCursor);
            document.querySelector("#latest-block").classList.remove("hidden");
            document.querySelector("#latest-block").classList.add("block");

            document
              .querySelector("#latest-block")
              .classList.add(`text-[${color}]`);
            document
              .querySelector("#ordfs-title")
              .classList.add(`text-[${color2}]`);
            Array.from(document.querySelectorAll(".api-item")).map((item) => {
              item.classList.add(
                "p-1",
                "rounded",
                "bg-[#111]",
                "my-2",
                `text-[${color2}]`
              );
            });

            document
              .querySelector("#ordfs-subtitle")
              .classList.add(`text-[${color}]`);
            document
              .querySelector("#primary-button")
              .classList.add(`bg-[${darkColor2}]`);
            document
              .querySelector("#secondary-button")
              .classList.add(`bg-[${darkColor}]`);
          }
        } catch (error) {
          console.error(error);
        }
      };
      document.addEventListener("DOMContentLoaded", async () => {
        await fetchBlockStats();
      });

      function stringToColor(input) {
        input = input.toString();

        let hash = 0;
        for (let i = 0; i < input.length; i++) {
          hash = input.charCodeAt(i) + ((hash << 5) - hash);
        }

        const hue = hash % 360;
        const saturation = 75;
        const lightness = 75;

        const rgbColor = hslToRgb(hue, saturation, lightness);
        const color = rgbToHex(rgbColor);

        return color;
      }

      function hslToRgb(h, s, l) {
        h /= 360;
        s /= 100;
        l /= 100;

        const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
        const p = 2 * l - q;

        const hueToRgb = (p, q, t) => {
          if (t < 0) t += 1;
          if (t > 1) t -= 1;
          if (t < 1 / 6) return p + (q - p) * 6 * t;
          if (t < 1 / 2) return q;
          if (t < 2 / 3) return p + (q - p) * (2 / 3 - t) * 6;
          return p;
        };

        const r = hueToRgb(p, q, h + 1 / 3);
        const g = hueToRgb(p, q, h);
        const b = hueToRgb(p, q, h - 1 / 3);

        return {
          r: Math.round(r * 255),
          g: Math.round(g * 255),
          b: Math.round(b * 255),
        };
      }

      function rgbToHex(rgb) {
        const toHex = (c) => c.toString(16).padStart(2, "0");
        const { r, g, b } = rgb;
        return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
      }

      const exampleHtml = `
  <!DOCTYPE html>
<html lang="en" style="height: 100%">
    <head>
      <title>ORD-FS DEMO</title>
    </head>
    <body style="margin: 0; padding: 0; height:100%">
        <div style="border-radius: 0.5rem;
        background: linear-gradient(to right, black, #800080);
        width: 100%; text-align: center; height:100%; display: flex; justify-content: center; align-items: center;">

            <!-- BSV INSCRIPTION REFERENCE -->
            <img src="/content/971388081f6601b0e502adbfceef68d152e7f27ba5aff0230d2567aaa8acb768_0" style="width:100px; margin-right: 1rem;" alt="BSV Inscription" title="BSV Inscription" />

            <!-- BTC INSCRIPTION REFERENCE -->
            <iframe src="/content/7286fc9119a7630bad27f98459d81802ad2e100f78ba0ab993bbf0546ad9f730i0" sandbox=" " scrolling="no" style="border: none; overflow: height: 100%; width: 10rem; margin-left: 1rem;" alt="BTC Inscription" title="BTC Inscription"></iframe>
        </div>
    </body>
</html>`;

      const closeTryItOut = () => {
        document.querySelector("#tryItOut").classList.remove("block");
        document.querySelector("#tryItOut").classList.add("hidden");
      };

      let htmlElement = null;

      document.addEventListener("DOMContentLoaded", () => {
        htmlElement = document.querySelector("#editor");
        var editor = ace.edit(htmlElement);
        editor.setTheme("ace/theme/monokai");
        editor.session.setMode("ace/mode/html");
        editor.setOptions({
          fontSize: "11pt",
          fontFamily: "Monaco, Menlo, Consolas",

          showLineNumbers: true,
          showGutter: true,
          vScrollBarAlwaysVisible: true,
          enableBasicAutocompletion: true,
          enableLiveAutocompletion: true,
        });
        editor.setValue(exampleHtml.trim());
        editor.clearSelection();
        editor.session.on("change", function (delta) {
          console.log(editor.getValue());
          preview(editor.getValue() || exampleHtml.trim());
        });
      });

      const inscribeCode = () => {
        let editor = ace.edit("editor");
        let code = editor.getValue();

        const b64Code = btoa(code);
        window.open(`https://1satordinals.com/inscribe?tab=html&code=${b64Code}`);
      };

      const copyCode = () => {
        let editor = ace.edit("editor");
        let copyText = editor.getValue();
        isClipboardWritingAllowed()
          .then(function (allowed) {
            if (allowed) {
              navigator.clipboard.writeText(copyText).then(function () {
                console.log(
                  "The text has been succesfully copied to the clipboard!"
                );
                document.getElementById("copy-label").innerHTML = "Copied!";
              });
            }
          })
          .catch(function (err) {
            console.log("Cannot copy to clipboard", err);
          });
      };

      const tryItOut = () => {
        let html = htmlElement.value;
        document.querySelector("#tryItOut").classList.remove("hidden");
        document.querySelector("#tryItOut").classList.add("block");

        if (!html || html.length === 0) {
          html = exampleHtml.trim();
          document.querySelector("#editor").value = html;
        }
        console.log({ html });
        try {
          const b64 = btoa(html);
          document.querySelector("#preview").src = `/preview/${b64}`;
        } catch (e) {
          console.error("Error displaying HTML code");
        }
      };

      function isClipboardWritingAllowed() {
        return new Promise(function (resolve, reject) {
          try {
            navigator.permissions
              .query({ name: "clipboard-write" })
              .then(function (status) {
                console.log(status);
                resolve(status.state == "granted");
              });
          } catch (error) {
            reject(error);
          }
        });
      }
    </script>
  </head>
  <body class="bg-black">
    <div class="bg-black text-white min-h-screen">
      <header class="relative">{{template "header" .}}</header>
    </div>
    <section class="relative transform-gpu overflow-hidden" aria-hidden="true">
      {{template "try" .}}
    </section>
    {{template "modals-try" .}}

    <footer class="">{{template "footer" .}}</footer>
  </body>
</html>
